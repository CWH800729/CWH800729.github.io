<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>連續壁澆置記錄表</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: "Microsoft JhengHei", sans-serif;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            max-width: 1200px;
        }
        .card {
            margin-bottom: 1rem;
        }
        .card-body {
            padding: 1rem;
        }
        .form-label {
            margin-bottom: 0.2rem;
            font-size: 1.1rem;
            font-weight: 500;
        }
        .form-control, .form-select {
            padding: 0.5rem;
            font-size: 1.1rem;
            height: calc(2em + 1rem + 2px);
        }
        /* 移除數字輸入框的上下箭頭 */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        .calculated-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #dc3545;
            background: none;
            border: none;
            padding: 0.5rem 0;
            width: 100%;
        }
        .calculated-value:focus {
            outline: none;
            box-shadow: none;
        }
        .mb-3 {
            margin-bottom: 0.5rem !important;
        }
        .chart-container {
            position: relative;
            margin: 20px 0;
            height: 600px;  /* 增加高度使圖表更接近正方形 */
            display: flex;
            align-items: flex-start;
        }
        .chart-wrapper {
            flex-grow: 1;
            position: relative;
            aspect-ratio: 1;  /* 保持正方形比例 */
            max-width: 600px;  /* 限制最大寬度 */
            margin: 0 auto;  /* 置中顯示 */
        }
        .chart-controls {
            margin-left: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
        }
        .chart-controls .form-check {
            margin-bottom: 10px;
        }
        .chart-controls .form-check-label {
            font-size: 0.9rem;
            white-space: nowrap;
        }
        .btn-group {
            margin: 10px 0;
        }
        .data-table {
            margin-top: 20px;
        }
        /* 表格樣式優化 */
        .table {
            font-size: 1.1rem;
            text-align: center;
        }
        .table th, .table td {
            white-space: nowrap;
            padding: 4px 8px;
            text-align: center;
        }
        .table th:nth-child(1), .table td:nth-child(1) { width: 50px; }
        .table th:nth-child(2), .table td:nth-child(2) { width: 90px; }
        .table th:nth-child(3), .table td:nth-child(3) { width: 100px; }
        .table th:nth-child(4), .table td:nth-child(4) { width: 100px; }
        .table th:nth-child(5), .table td:nth-child(5) { width: 110px; }
        .table th:nth-child(6), .table td:nth-child(6) { width: 110px; }
        .table th.concrete-volume, .table td.concrete-volume { width: 120px; }
        .item-number {
            min-width: 60px;
            font-weight: bold;
            background-color: #f8f9fa;
        }
        @media print {
            .no-print {
                display: none !important;
            }
            .container {
                box-shadow: none;
            }
        }
        .table input:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        .table.disabled {
            opacity: 0.7;
        }
        .table.disabled input {
            pointer-events: none;
            background-color: #e9ecef;
        }
        .table.disabled .btn {
            pointer-events: none;
            opacity: 0.7;
        }
        .theoretical-remaining, .actual-remaining {
            display: none;  /* 初始設定為隱藏 */
        }
        .theoretical-remaining.show, .actual-remaining.show {
            display: table-cell;
        }
        .btn-group .btn.active {
            background-color: #6c757d;
            color: white;
        }
        /* 修改混凝土量顯示控制樣式 */
        .concrete-volume {
            display: none;  /* 初始設定為隱藏 */
        }
        .concrete-volume.show {
            display: table-cell;
        }
        /* 圖片點擊樣式 */
        .clickable-image {
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .clickable-image:hover {
            transform: scale(1.05);
        }

        .clickable-image:active {
            transform: scale(0.95);
        }

        .click-count {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .click-count.show {
            opacity: 1;
        }

        .image-container {
            position: relative;
            display: inline-block;
        }

        .logo-link {
            pointer-events: none;
        }

        .logo-link.active {
            pointer-events: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 修改標題區域，將檔案名稱顯示移到右側 -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="text-center">
                <div class="image-container">
                    <a href="https://CWH800729.github.io/index.html" class="logo-link" id="logoLink">
                        <img src="https://CWH800729.github.io/CWH-LOGO" alt="CWH-LOGO" style="height: 60px; margin-right: 15px;" class="clickable-image" id="logoImage">
                    </a>
                    <div class="click-count" id="clickCount">0</div>
                </div>
                <h1 class="d-inline-block align-middle mb-0">連續壁澆置記錄表</h1>
            </div>
            <div id="importedFileName" class="text-muted" style="display: none;">
                已匯入檔案：<span class="fw-bold"></span>
            </div>
        </div>
        
        <!-- 匯出匯入按鈕 -->
        <div class="d-flex justify-content-end mb-3">
            <button class="btn btn-success me-2" onclick="exportUnitData()">匯出單元資料</button>
            <button class="btn btn-primary" onclick="importUnitData()">匯入單元資料</button>
        </div>

        <!-- 單元規格輸入表單 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">單元規格</h5>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-2">
                        <label class="form-label">日期</label>
                        <input type="date" class="form-control" id="unitDate">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">單元編號</label>
                        <input type="text" class="form-control" id="unitNumber">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">公/母單元</label>
                        <select class="form-select" id="unitType">
                            <option value="公">公單元</option>
                            <option value="母">母單元</option>
                        </select>
                    </div>
                </div>
                <div class="row g-2 mt-1">
                    <div class="col-md-4">
                        <label class="form-label">單元寬(m)</label>
                        <input type="text" class="form-control" id="unitWidth" onchange="calculateVolume()">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">單元長(m)</label>
                        <input type="text" class="form-control" id="unitLength" onchange="calculateVolume()">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">深度(m)</label>
                        <input type="text" class="form-control" id="unitDepth" onchange="calculateVolume()">
                    </div>
                </div>
                <div class="row g-2 mt-1">
                    <div class="col-md-4">
                        <label class="form-label">單元體積(m³)</label>
                        <div class="calculated-value" id="unitVolume">0.00</div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">單元面積(m²)</label>
                        <div class="calculated-value" id="unitArea">0.00</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 圖表區域 -->
        <div class="chart-container">
            <div class="chart-wrapper">
                <canvas id="groutingChart"></canvas>
            </div>
            <div class="chart-controls">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="showFillArea" checked>
                    <label class="form-check-label" for="showFillArea">
                        顯示曲線間填滿區域
                    </label>
                </div>
            </div>
        </div>

        <!-- 新的混凝土澆置記錄表格區塊 -->
        <div class="table-responsive" id="newConcreteTableArea">
            <table id="newConcreteTable" class="table table-bordered table-sm align-middle">
                <thead>
                    <tr>
                        <th>項次</th>
                        <th>澆置方數</th>
                        <th>累計方數</th>
                        <th>預估高度</th>
                        <th>實際平均高度</th>
                        <th>實際高度1</th>
                        <th>實際高度2</th>
                        <th>實際高度3</th>
                        <th>實際高度4</th>
                        <th>備註</th>
                        <th class="actual-supply-col" style="display:none;">實際需補料</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- 新表格控制按鈕 -->
        <div class="mb-2 d-flex gap-2">
            <button class="btn btn-primary btn-sm" onclick="exportNewConcreteTable()">匯出資料</button>
            <button class="btn btn-secondary btn-sm" onclick="importNewConcreteTable()">匯入資料</button>
            <button class="btn btn-outline-info btn-sm" onclick="toggleActualSupplyCol()" id="toggleActualSupplyBtn">顯示實際需補料</button>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 初始化圖表
        let groutingChart;
        let showFillArea = true;  // 控制是否顯示填滿區域

        function initChart() {
            const unitDepth = parseFloat(document.getElementById('unitDepth').value) || 0;
            const ctx = document.getElementById('groutingChart').getContext('2d');
            
            // 計算合適的刻度範圍
            const maxDepth = Math.ceil(unitDepth / 5) * 5;  // 向上取整到最接近的5的倍數
            
            // 創建漸層填充
            const gradientFill = ctx.createLinearGradient(0, 0, 0, 400);
            gradientFill.addColorStop(0, 'rgba(255, 193, 7, 0.2)');
            gradientFill.addColorStop(1, 'rgba(255, 193, 7, 0.05)');

            groutingChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [0],
                    datasets: [{
                        label: '預估設計曲線',
                        data: [unitDepth],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        tension: 0.1,
                        borderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        fill: false
                    },
                    {
                        label: '實際澆置曲線',
                        data: [unitDepth],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.1,
                        borderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        fill: false
                    },
                    {
                        label: '曲線間區域',
                        data: [unitDepth],
                        borderColor: 'transparent',
                        backgroundColor: gradientFill,
                        tension: 0.1,
                        borderWidth: 0,
                        pointRadius: 0,
                        fill: '+1',
                        hidden: !showFillArea
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1,  // 保持正方形
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                filter: function(legendItem, data) {
                                    return legendItem.datasetIndex !== 2;
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.datasetIndex === 2) return null;
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(2) + ' m';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            reverse: false,
                            title: {
                                display: true,
                                text: '累計體積 (m³)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            reverse: true,
                            min: 0,
                            max: function() {
                                const unitDepth = parseFloat(document.getElementById('unitDepth').value) || 0;
                                return Math.ceil(unitDepth / 5) * 5;  // 向上取整到最接近的5的倍數
                            },
                            ticks: {
                                stepSize: 1,  // 小刻度間距為1m
                                callback: function(value) {
                                    // 每5m顯示一個大刻度，其他顯示小刻度
                                    if (value % 5 === 0) {
                                        return value;
                                    }
                                    return '';
                                },
                                font: {
                                    size: 12,
                                    weight: 'normal'
                                },
                                color: function(context) {
                                    // 大刻度（5m的倍數）使用深色，小刻度使用淺色
                                    return context.tick.value % 5 === 0 ? 'rgba(0, 0, 0, 0.8)' : 'rgba(0, 0, 0, 0.4)';
                                }
                            },
                            grid: {
                                color: function(context) {
                                    // 每5m顯示實線，其他顯示虛線
                                    if (context.tick.value % 5 === 0) {
                                        return 'rgba(0, 0, 0, 0.2)';
                                    }
                                    return 'rgba(0, 0, 0, 0.1)';
                                },
                                lineWidth: function(context) {
                                    // 每5m顯示粗線，其他顯示細線
                                    if (context.tick.value % 5 === 0) {
                                        return 1;
                                    }
                                    return 0.5;
                                },
                                borderDash: function(context) {
                                    // 每5m顯示實線，其他顯示虛線
                                    if (context.tick.value % 5 === 0) {
                                        return [];
                                    }
                                    return [5, 5];
                                }
                            },
                            title: {
                                display: true,
                                text: '深度 (m)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                }
            });

            // 添加切換按鈕事件監聽器
            document.getElementById('showFillArea').addEventListener('change', function(e) {
                showFillArea = e.target.checked;
                updateChart();
            });
        }

        // 計算體積和面積
        function calculateVolume() {
            const width = parseFloat(document.getElementById('unitWidth').value) || 0;
            const length = parseFloat(document.getElementById('unitLength').value) || 0;
            const depth = parseFloat(document.getElementById('unitDepth').value) || 0;
            
            const volume = width * length * depth;
            const area = width * length;
            
            document.getElementById('unitVolume').textContent = volume.toFixed(2);
            document.getElementById('unitArea').textContent = area.toFixed(2);

            // 當體積計算完成後，自動填充混凝土數據表格
            if (volume > 0) {
                autoFillConcreteData(volume);
            }
        }

        // 修改自動填充混凝土數據函數
        function autoFillConcreteData(volume) {
            const tbody = document.querySelector('#concreteDataTable tbody');
            tbody.innerHTML = '';
            const rowCount = Math.ceil(volume / 9);
            const thead = document.querySelector('#concreteDataTable thead tr');
            const depthColumns = thead.querySelectorAll('th').length - 6; // 6個基本欄位
            for (let i = 0; i < rowCount; i++) {
                let rowHtml = `
                    <td class="item-number">${i + 1}</td>
                    <td><input type="number" class="form-control" step="0.01" oninput="updateConcreteData()"></td>
                    <td class="calculated-value">0.00</td>
                    <td class="calculated-value">0.00</td>
                    <td class="calculated-value">0.00</td>
                    <td><input type="number" class="form-control" step="0.01" oninput="calculateAverageDepth(this)"></td>
                `;
                if (depthColumns > 1) {
                    for (let j = 1; j < depthColumns; j++) {
                        rowHtml += `<td><input type="number" class="form-control" step="0.01" oninput="calculateAverageDepth(this)"></td>`;
                    }
                }
                rowHtml += '<td class="calculated-value concrete-volume">0.00</td><td class="calculated-value concrete-volume">0.00</td>';
                const newRow = document.createElement('tr');
                newRow.innerHTML = rowHtml;
                tbody.appendChild(newRow);
            }
            updateConcreteData();
        }

        // 修改更新混凝土數據函數
        function updateConcreteData() {
            const rows = document.querySelectorAll('#concreteDataTable tbody tr');
            let cumulativeVolume = 0;
            const unitWidth = parseFloat(document.getElementById('unitWidth').value) || 0;
            const unitLength = parseFloat(document.getElementById('unitLength').value) || 0;
            const unitDepth = parseFloat(document.getElementById('unitDepth').value) || 0;
            const unitArea = unitWidth * unitLength;
            const designVolume = parseFloat(document.getElementById('unitVolume').textContent) || 0;

            rows.forEach((row) => {
                const volume = parseFloat(row.querySelector('td:nth-child(2) input').value) || 0;
                cumulativeVolume += volume;
                
                // 更新累計體積
                row.querySelector('td:nth-child(3)').textContent = cumulativeVolume.toFixed(2);
                
                // 更新理論深度
                const plannedDepth = unitDepth - (cumulativeVolume / unitArea);
                row.querySelector('td:nth-child(4)').textContent = plannedDepth.toFixed(2);
                
                // 更新理論剩餘
                const theoreticalRemaining = designVolume - cumulativeVolume;
                row.querySelector('td:nth-last-child(2)').textContent = theoreticalRemaining.toFixed(2);
                
                // 更新實際需求混凝土量
                const averageDepth = parseFloat(row.querySelector('td:nth-child(5)').textContent) || 0;
                const actualConcreteVolume = averageDepth * unitArea;
                row.querySelector('td:nth-last-child(1)').textContent = actualConcreteVolume.toFixed(2);
            });
            
            // 更新圖表
            updateChart();
        }

        // 修改計算實際平均深度函數
        function calculateAverageDepth(input) {
            const row = input.closest('tr');
            const depthInputs = row.querySelectorAll('td:nth-child(n+6):not(:nth-last-child(-n+2)) input');
            let sum = 0;
            let count = 0;
            
            depthInputs.forEach(input => {
                const value = parseFloat(input.value) || 0;
                if (value > 0) {
                    sum += value;
                    count++;
                }
            });
            
            const averageDepth = count > 0 ? sum / count : 0;
            row.querySelector('td:nth-child(5)').textContent = averageDepth.toFixed(2);
            
            // 更新實際需求混凝土量
            const unitWidth = parseFloat(document.getElementById('unitWidth').value) || 0;
            const unitLength = parseFloat(document.getElementById('unitLength').value) || 0;
            const unitArea = unitWidth * unitLength;
            const actualConcreteVolume = averageDepth * unitArea;
            row.querySelector('td:nth-last-child(1)').textContent = actualConcreteVolume.toFixed(2);
            
            // 更新圖表
            updateConcreteData();
        }

        // 修改切換顯示函數
        function toggleConcreteVolume() {
            const button = event.target.closest('button');
            const cells = document.querySelectorAll('.concrete-volume');
            const isHidden = !cells[0].classList.contains('show');
            
            cells.forEach(cell => {
                cell.classList.toggle('show');
            });
            
            button.classList.toggle('active');
            button.querySelector('i').className = isHidden ? 'fas fa-eye-slash' : 'fas fa-eye';
        }

        // 修改表頭：只針對實際深度欄位加上移除按鈕
        function refreshDepthHeaders() {
            const thead = document.querySelector('#concreteDataTable thead tr:last-child');
            if (!thead) return;
            const ths = thead.querySelectorAll('th');
            for (let i = 0; i < ths.length; i++) {
                if (i >= 0) {
                    // 只針對第6欄(含)以後的th加垃圾桶
                    if (i >= 0) {
                        ths[i].innerHTML = `實際深度 ${i + 1} <button type='button' class='btn btn-link btn-sm p-0' onclick='removeSpecificDepthColumn(${i})' title='移除此欄位'><i class="fas fa-trash-alt"></i></button>`;
                    }
                }
            }
        }

        // 新增深度欄位
        function addDepthColumn() {
            const thead = document.querySelector('#concreteDataTable thead tr:last-child');
            const tbody = document.querySelector('#concreteDataTable tbody');
            const currentColumns = thead.querySelectorAll('th').length;
            // 新增標題欄位
            const newTh = document.createElement('th');
            newTh.innerHTML = `實際深度 ${currentColumns + 1} <button type='button' class='btn btn-link btn-sm p-0' onclick='removeSpecificDepthColumn(${currentColumns})' title='移除此欄位'><i class="fas fa-trash-alt"></i></button>`;
            thead.appendChild(newTh);
            // 為每一行添加新的輸入框
            const rows = tbody.querySelectorAll('tr');
            rows.forEach(row => {
                const newTd = document.createElement('td');
                newTd.innerHTML = '<input type="number" class="form-control" step="0.01" oninput="calculateAverageDepth(this)">';
                row.appendChild(newTd);
            });
            refreshDepthHeaders();
            updateChart();
        }

        // 允許移除任意深度欄位
        function removeSpecificDepthColumn(idx) {
            const thead = document.querySelector('#concreteDataTable thead tr:last-child');
            const tbody = document.querySelector('#concreteDataTable tbody');
            const depthCount = thead.querySelectorAll('th').length;
            if (depthCount <= 1) {
                alert('至少需要保留一個實際深度欄位');
                return;
            }
            thead.removeChild(thead.children[idx]);
            // 移除每一行的對應欄位
            const rows = tbody.querySelectorAll('tr');
            rows.forEach(row => {
                row.removeChild(row.children[5 + idx]);
                calculateAverageDepth(row.querySelector('td:nth-child(5) input') || row.querySelector('td:nth-child(6) input'));
            });
            refreshDepthHeaders();
            updateChart();
        }

        // 新增混凝土數據行
        function addConcreteDataRow() {
            const tbody = document.querySelector('#concreteDataTable tbody');
            const newRow = document.createElement('tr');
            const rowNumber = tbody.children.length + 1;
            const thead = document.querySelector('#concreteDataTable thead tr');
            const depthColumns = thead.querySelectorAll('th').length - 6;
            let rowHtml = `
                <td class="item-number">${rowNumber}</td>
                <td><input type="number" class="form-control" step="0.01" oninput="updateConcreteData()"></td>
                <td class="calculated-value">0.00</td>
                <td class="calculated-value">0.00</td>
                <td class="calculated-value">0.00</td>
                <td><input type="number" class="form-control" step="0.01" oninput="calculateAverageDepth(this)"></td>
            `;
            if (depthColumns > 1) {
                for (let j = 1; j < depthColumns; j++) {
                    rowHtml += `<td><input type="number" class="form-control" step="0.01" oninput="calculateAverageDepth(this)"></td>`;
                }
            }
            rowHtml += '<td class="calculated-value concrete-volume">0.00</td><td class="calculated-value concrete-volume">0.00</td>';
            newRow.innerHTML = rowHtml;
            tbody.appendChild(newRow);
            updateConcreteData();
        }

        // 修改匯出功能
        function exportUnitData() {
            const unitNumber = document.getElementById('unitNumber').value.trim();
            if (!unitNumber) {
                alert('請先填入單元編號後再匯出資料');
                return;
            }

            // 生成日期時間字串 (格式：YYYYMMDD-HHmm)
            const now = new Date();
            const dateStr = now.getFullYear() +
                String(now.getMonth() + 1).padStart(2, '0') +
                String(now.getDate()).padStart(2, '0') + '-' +
                String(now.getHours()).padStart(2, '0') +
                String(now.getMinutes()).padStart(2, '0');

            // 準備CSV內容
            let csvContent = '\ufeff'; // 添加BOM以確保Excel正確顯示中文
            
            // 單元規格
            csvContent += '單元規格\n';
            csvContent += '日期,單元編號,單元類型,單元寬度(m),單元長度(m),單元深度(m)\n';
            csvContent += `${document.getElementById('unitDate').value},${unitNumber},${document.getElementById('unitType').value},${document.getElementById('unitWidth').value},${document.getElementById('unitLength').value},${document.getElementById('unitDepth').value}\n\n`;
            
            // 混凝土量與深度數據
            csvContent += '混凝土量與深度數據\n';
            const thead = document.querySelector('#concreteDataTable thead');
            const headerRow1 = thead.querySelector('tr:first-child');
            const headerRow2 = thead.querySelector('tr:last-child');
            
            // 合併兩行標題
            let headers = [];
            for (let i = 0; i < headerRow1.children.length; i++) {
                if (i < 7) { // 基本欄位
                    headers.push(headerRow1.children[i].textContent.trim());
                } else { // 實際深度欄位
                    headers.push(headerRow2.children[i-7].textContent.trim());
                }
            }
            csvContent += headers.join(',') + '\n';
            
            // 數據行
            const rows = document.querySelectorAll('#concreteDataTable tbody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = [];
                
                cells.forEach((cell, index) => {
                    if (index === 1) { // 澆置體積
                        rowData.push(cell.querySelector('input').value);
                    } else if (index >= 7) { // 實際深度輸入框
                        rowData.push(cell.querySelector('input').value);
                    } else { // 其他計算值
                        rowData.push(cell.textContent.trim());
                    }
                });
                
                csvContent += rowData.join(',') + '\n';
            });
            
            // 修改下載檔案名稱格式
            const fileName = `${dateStr}-${unitNumber}-連續壁澆置記錄表.csv`;
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.click();
        }

        // 修改匯入功能
        function importUnitData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv,.txt';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                // 顯示匯入的檔案名稱
                const fileNameDisplay = document.getElementById('importedFileName');
                const fileNameSpan = fileNameDisplay.querySelector('span');
                fileNameSpan.textContent = file.name;
                fileNameDisplay.style.display = 'block';

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        const lines = content.split('\n');
                        
                        // 解析單元規格
                        let currentSection = '';
                        let specsLine = null;
                        
                        for (let i = 0; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (!line) continue;
                            
                            if (line === '單元規格') {
                                currentSection = 'specs';
                                continue;
                            } else if (line === '混凝土量與深度數據') {
                                currentSection = 'concrete';
                                continue;
                            }
                            
                            if (currentSection === 'specs' && !line.startsWith('日期')) {
                                specsLine = line.split(',');
                                break;
                            }
                        }
                        
                        if (specsLine) {
                            // 填充單元規格
                            document.getElementById('unitDate').value = specsLine[0] || '';
                            document.getElementById('unitNumber').value = specsLine[1] || '';
                            document.getElementById('unitType').value = specsLine[2] || '公';
                            document.getElementById('unitWidth').value = specsLine[3] || '';
                            document.getElementById('unitLength').value = specsLine[4] || '';
                            document.getElementById('unitDepth').value = specsLine[5] || '';
                            // 觸發體積計算
                            calculateVolume();
                        }
                        
                        // 解析混凝土數據
                        let concreteDataStart = false;
                        let headerFound = false;
                        let headerLine = '';
                        const concreteData = [];
                        
                        for (let i = 0; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (!line) continue;
                            
                            if (line === '混凝土量與深度數據') {
                                concreteDataStart = true;
                                continue;
                            }
                            
                            if (concreteDataStart) {
                                if (!headerFound) {
                                    headerFound = true;
                                    headerLine = line;
                                    continue;
                                }
                                const rowData = line.split(',');
                                if (rowData.length >= 7) {
                                    concreteData.push(rowData);
                                }
                            }
                        }

                        // 計算實際深度欄位數量
                        const headerColumns = headerLine.split(',');
                        const depthColumnCount = Math.max(0, headerColumns.length - 6); // 減去基本欄位數量，確保不小於0
                        
                        // 更新表格標題
                        const thead = document.querySelector('#concreteDataTable thead tr:last-child');
                        thead.innerHTML = ''; // 清空現有的深度欄位
                        
                        // 添加新的深度欄位
                        for (let i = 0; i < depthColumnCount; i++) {
                            const newTh = document.createElement('th');
                            newTh.innerHTML = `實際深度 ${i + 1} <button type='button' class='btn btn-link btn-sm p-0' onclick='removeSpecificDepthColumn(${i})' title='移除此欄位'><i class="fas fa-trash-alt"></i></button>`;
                            thead.appendChild(newTh);
                        }
                        
                        // 填充混凝土數據表格
                        if (concreteData.length > 0) {
                            const tbody = document.querySelector('#concreteDataTable tbody');
                            tbody.innerHTML = '';
                            
                            concreteData.forEach((rowData, index) => {
                                const newRow = document.createElement('tr');
                                let rowHtml = `
                                    <td class="item-number">${index + 1}</td>
                                    <td><input type="number" class="form-control" step="0.01" value="${rowData[1]}" oninput="updateConcreteData()"></td>
                                    <td class="calculated-value">${rowData[2]}</td>
                                    <td class="calculated-value">${rowData[3]}</td>
                                    <td class="calculated-value">${rowData[4]}</td>
                                `;
                                
                                // 添加實際深度輸入框
                                for (let i = 5; i < rowData.length; i++) {
                                    rowHtml += `<td><input type="number" class="form-control" step="0.01" value="${rowData[i]}" oninput="calculateAverageDepth(this)"></td>`;
                                }
                                
                                newRow.innerHTML = rowHtml;
                                tbody.appendChild(newRow);
                            });

                            // 更新圖表
                            updateChart();
                        }
                    } catch (error) {
                        alert('匯入數據格式錯誤：' + error.message);
                        document.getElementById('importedFileName').style.display = 'none';
                    }
                };
                reader.readAsText(file, 'UTF-8');
            };
            input.click();
        }

        // 在清空數據時也要隱藏檔案名稱顯示
        function clearData() {
            // ... 原有的清空邏輯 ...
            document.getElementById('importedFileName').style.display = 'none';
        }

        // 修改初始化事件監聽器
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                initChart();
                ['unitWidth', 'unitLength', 'unitDepth'].forEach(id => {
                    document.getElementById(id).addEventListener('input', function() {
                        calculateVolume();
                        initChart();
                    });
                });

                // 初始化按鈕狀態
                const concreteVolumeBtn = document.querySelector('button[onclick="toggleConcreteVolume()"]');
                concreteVolumeBtn.classList.remove('active');
            }, 100);
        });

        // 參數設定
        function getUnitVolume() {
            return parseFloat(document.getElementById('unitVolume')?.textContent) || 0;
        }
        function getUnitArea() {
            return parseFloat(document.getElementById('unitArea')?.textContent) || 0;
        }
        function getUnitDepth() {
            return parseFloat(document.getElementById('unitDepth')?.value) || 0;
        }

        // 產生表格
        function initNewConcreteTable() {
            const tbody = document.querySelector('#newConcreteTable tbody');
            tbody.innerHTML = '';
            const unitVolume = getUnitVolume();
            const rowCount = Math.max(2, Math.ceil(unitVolume / 9) + 1); // 至少2行
            for (let i = 0; i < rowCount; i++) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${i}</td>
                    <td><input type="number" class="form-control form-control-sm" step="0.01" oninput="updateNewConcreteTable()"></td>
                    <td class="calculated-value">0.00</td>
                    <td class="calculated-value">0.00</td>
                    <td class="calculated-value">0.00</td>
                    <td><input type="number" class="form-control form-control-sm" step="0.01" oninput="updateNewConcreteTable()"></td>
                    <td><input type="number" class="form-control form-control-sm" step="0.01" oninput="updateNewConcreteTable()"></td>
                    <td><input type="number" class="form-control form-control-sm" step="0.01" oninput="updateNewConcreteTable()"></td>
                    <td><input type="number" class="form-control form-control-sm" step="0.01" oninput="updateNewConcreteTable()"></td>
                    <td><input type="text" class="form-control form-control-sm"></td>
                    <td class="actual-supply-col" style="display:none;">0.00</td>
                `;
                tbody.appendChild(tr);
            }
            updateNewConcreteTable();
        }

        // 更新計算欄位
        function updateNewConcreteTable() {
            const tbody = document.querySelector('#newConcreteTable tbody');
            const unitArea = getUnitArea();
            const unitDepth = getUnitDepth();
            let cumulative = 0;
            tbody.querySelectorAll('tr').forEach((tr, idx) => {
                // 澆置方數
                const pourInput = tr.children[1].querySelector('input');
                const pour = parseFloat(pourInput?.value) || 0;
                // 累計方數
                cumulative += pour;
                tr.children[2].textContent = cumulative.toFixed(2);
                // 預估高度
                let estHeight = unitDepth;
                if (unitArea > 0) estHeight = unitDepth - (cumulative / unitArea);
                tr.children[3].textContent = estHeight.toFixed(2);
                // 實際高度1~4
                let actuals = [];
                for (let i = 5; i <= 8; i++) {
                    const val = parseFloat(tr.children[i].querySelector('input')?.value);
                    if (!isNaN(val)) actuals.push(val);
                }
                // 實際平均高度
                let avg = actuals.length ? actuals.reduce((a,b)=>a+b,0)/actuals.length : 0;
                tr.children[4].textContent = avg.toFixed(2);
                // 備註不處理
                // 實際需補料
                const supplyCell = tr.querySelector('.actual-supply-col');
                if (supplyCell) {
                    const supply = (unitDepth - avg) * unitArea;
                    supplyCell.textContent = isNaN(supply) ? '' : supply.toFixed(2);
                }
            });
        }

        // 補料欄顯示/隱藏
        function toggleActualSupplyCol() {
            const show = document.querySelector('.actual-supply-col')?.style.display === 'none';
            document.querySelectorAll('.actual-supply-col').forEach(td => td.style.display = show ? '' : 'none');
            document.querySelector('#newConcreteTable thead th.actual-supply-col').style.display = show ? '' : 'none';
            document.getElementById('toggleActualSupplyBtn').textContent = show ? '隱藏實際需補料' : '顯示實際需補料';
        }

        // 匯出功能
        function exportNewConcreteTable() {
            // 取得單元規格
            const unitDate = document.getElementById('unitDate').value;
            const unitNumber = document.getElementById('unitNumber').value.trim();
            const unitType = document.getElementById('unitType').value;
            const unitWidth = document.getElementById('unitWidth').value;
            const unitLength = document.getElementById('unitLength').value;
            const unitDepth = document.getElementById('unitDepth').value;
            const unitVolume = document.getElementById('unitVolume').textContent;
            const unitArea = document.getElementById('unitArea').textContent;

            // 檢查單元編號
            if (!unitNumber) {
                alert('請先填入單元編號後再匯出資料');
                return;
            }

            // 生成日期時間字串 (格式：YYYYMMDD-HHmm)
            const now = new Date();
            const dateStr = now.getFullYear() +
                String(now.getMonth() + 1).padStart(2, '0') +
                String(now.getDate()).padStart(2, '0') + '-' +
                String(now.getHours()).padStart(2, '0') +
                String(now.getMinutes()).padStart(2, '0');

            // 準備CSV內容
            let csv = '\ufeff'; // BOM for Excel
            csv += '單元規格\n';
            csv += '日期,單元編號,單元類型,單元寬度(m),單元長度(m),單元深度(m),單元體積(m³),單元面積(m²)\n';
            csv += `${unitDate},${unitNumber},${unitType},${unitWidth},${unitLength},${unitDepth},${unitVolume},${unitArea}\n\n`;
            csv += '混凝土澆置記錄表\n';
            csv += '項次,澆置方數,累計方數,預估高度,實際平均高度,實際高度1,實際高度2,實際高度3,實際高度4,備註,實際需補料\n';
            const unitAreaNum = parseFloat(unitArea) || 0;
            const unitDepthNum = parseFloat(unitDepth) || 0;
            document.querySelectorAll('#newConcreteTable tbody tr').forEach(tr => {
                let row = [];
                // 取得實際高度1~4
                let actuals = [];
                for (let i = 5; i <= 8; i++) {
                    const input = tr.children[i].querySelector('input');
                    actuals.push(parseFloat(input ? input.value : '0') || 0);
                }
                // 判斷是否全為0
                const allZero = actuals.every(v => v === 0);
                // 實際平均高度
                const avg = actuals.filter(v => v > 0).length > 0 ? (actuals.reduce((a,b)=>a+b,0)/actuals.filter(v=>v>0).length) : 0;
                for (let i = 0; i < 11; i++) {
                    if (i === 1 || (i >= 5 && i <= 8) || i === 9) {
                        // input 欄位
                        const input = tr.children[i].querySelector('input');
                        row.push(input ? input.value : '');
                    } else if (i === 10) { // 實際需補料
                        if (allZero) {
                            row.push('-');
                        } else {
                            const supply = (unitDepthNum - avg) * unitAreaNum;
                            row.push(isNaN(supply) ? '' : supply.toFixed(2));
                        }
                    } else {
                        row.push(tr.children[i].textContent);
                    }
                }
                csv += row.join(',') + '\n';
            });
            const fileName = `${dateStr}-${unitNumber}-連續壁記錄表.csv`;
            const blob = new Blob([csv], {type:'text/csv'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = fileName;
            a.click();
        }
        // 匯入功能
        function importNewConcreteTable() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(e) {
                    const lines = e.target.result.split('\n').filter(l=>l.trim());
                    if (lines.length < 2) return;
                    const tbody = document.querySelector('#newConcreteTable tbody');
                    tbody.innerHTML = '';
                    for (let i = 1; i < lines.length; i++) {
                        const cols = lines[i].split(',');
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${cols[0]||''}</td>
                            <td><input type="number" class="form-control form-control-sm" step="0.01" value="${cols[1]||''}" oninput="updateNewConcreteTable()"></td>
                            <td class="calculated-value">${cols[2]||'0.00'}</td>
                            <td class="calculated-value">${cols[3]||'0.00'}</td>
                            <td class="calculated-value">${cols[4]||'0.00'}</td>
                            <td><input type="number" class="form-control form-control-sm" step="0.01" value="${cols[5]||''}" oninput="updateNewConcreteTable()"></td>
                            <td><input type="number" class="form-control form-control-sm" step="0.01" value="${cols[6]||''}" oninput="updateNewConcreteTable()"></td>
                            <td><input type="number" class="form-control form-control-sm" step="0.01" value="${cols[7]||''}" oninput="updateNewConcreteTable()"></td>
                            <td><input type="number" class="form-control form-control-sm" step="0.01" value="${cols[8]||''}" oninput="updateNewConcreteTable()"></td>
                            <td><input type="text" class="form-control form-control-sm" value="${cols[9]||''}"></td>
                            <td class="actual-supply-col" style="display:none;">${cols[10]||'0.00'}</td>
                        `;
                        tbody.appendChild(tr);
                    }
                    updateNewConcreteTable();
                };
                reader.readAsText(file);
            };
            input.click();
        }
        // 單元體積/面積/深度變動時自動重建表格
        ['unitVolume','unitArea','unitDepth'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('input', initNewConcreteTable);
                el.addEventListener('change', initNewConcreteTable);
            }
        });
        // 頁面載入時自動產生表格
        window.addEventListener('DOMContentLoaded', initNewConcreteTable);

        // LOGO點擊計數功能
        let clickCount = 0;
        const logoImage = document.getElementById('logoImage');
        const clickCountElement = document.getElementById('clickCount');
        const logoLink = document.getElementById('logoLink');

        logoImage.addEventListener('click', function(e) {
            e.preventDefault();
            clickCount++;
            clickCountElement.textContent = clickCount;
            clickCountElement.classList.add('show');
            
            if (clickCount >= 3) {
                logoLink.classList.add('active');
                setTimeout(() => {
                    window.location.href = logoLink.href;
                }, 100);
            }
            
            setTimeout(() => {
                clickCountElement.classList.remove('show');
            }, 1000);
        });
    </script>
</body>
</html> 
